<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>모바일 3D 모델링 (앨범만)</title>
  <style>
    :root { --bg:#0b0d12; --panel:#0f1422; --muted:#1b2030; --text:#eaf0ff; }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;}
    .top{position:sticky; top:0; z-index:10; display:flex; gap:8px; padding:10px; background:linear-gradient(180deg, rgba(15,20,34,.95), rgba(15,20,34,.75)); border-bottom:1px solid var(--muted); backdrop-filter:blur(8px);}
    .btn{flex:1; min-height:44px; border-radius:14px; border:1px solid var(--muted); background:#1c2640; color:#fff; font-weight:700; font-size:15px;}
    .btn.a{ background:#2b74ff; }
    .file{ display:none; }
    .status{ padding:8px 12px; font-size:12px; color:#b7c4ff; }
    .view{ position:relative; height: calc(100dvh - 66px); } /* topbar approx height */
    #c{ width:100%; height:100%; display:block; touch-action:none; }
    .hud{ position:absolute; left:10px; bottom:10px; font-size:12px; background:#0b0d12cc; border:1px solid var(--muted); padding:6px 8px; border-radius:10px; }
  </style>
</head>
<body>
  <div class="top">
    <label for="file" class="btn a">앨범에서 사진 선택</label>
    <button id="btnGrid" class="btn">그리드</button>
    <button id="btnReset" class="btn">리셋</button>
    <button id="btnGLB" class="btn a">GLB</button>
    <button id="btnOBJ" class="btn a">OBJ</button>
    <input id="file" class="file" type="file" accept="image/*"/>  <!-- no capture attr -->
  </div>
  <div class="status" id="status">대기 중…</div>
  <div class="view">
    <canvas id="c"></canvas>
    <div class="hud">드래그 회전 · 두 손 패닝 · 핀치 줌</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.164.1/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.164.1/examples/js/exporters/GLTFExporter.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.164.1/examples/js/exporters/OBJExporter.js"></script>
  <script>
    const statusEl = document.getElementById('status');
    function setStatus(s){ statusEl.textContent = s; }

    const canvas = document.getElementById('c');
    const renderer = new THREE.WebGLRenderer({canvas, antialias:true, powerPreference:'high-performance'});
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b0d12);

    const camera = new THREE.PerspectiveCamera(55, 1, 0.01, 200);
    camera.position.set(1.2, 0.9, 1.2);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.screenSpacePanning = true;

    const hemi = new THREE.HemisphereLight(0xffffff, 0x223, 0.8);
    const dir = new THREE.DirectionalLight(0xffffff, 0.9);
    dir.position.set(1.5, 2.5, 1.2);
    scene.add(hemi, dir);

    const grid = new THREE.GridHelper(4, 8, 0x334455, 0x223344);
    grid.material.opacity = 0.35; grid.material.transparent = true;
    scene.add(grid);

    let plane = null;
    let texture = null;

    function fit(){
      const rect = canvas.parentElement.getBoundingClientRect();
      renderer.setSize(rect.width, rect.height, false);
      camera.aspect = rect.width/rect.height;
      camera.updateProjectionMatrix();
    }
    new ResizeObserver(fit).observe(canvas.parentElement); fit();

    function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
    animate();

    async function blobToImageBitmapOrImage(blob){
      // Prefer createImageBitmap when available for better mobile reliability
      try {
        if ('createImageBitmap' in window) {
          const bmp = await createImageBitmap(blob);
          return { type:'bitmap', data:bmp, width:bmp.width, height:bmp.height };
        }
      } catch(e){ console.warn('createImageBitmap 실패, Image()로 대체', e); }
      // Fallback to HTMLImageElement
      const url = URL.createObjectURL(blob);
      await new Promise((resolve, reject)=>{
        const img = new Image();
        img.onload = ()=>{ resolve(img); };
        img.onerror = ()=>{ reject(new Error('이미지 로드 실패')); };
        img.src = url;
      });
      const img = new Image(); // need a fresh one because previous was lost in closure
      img.src = URL.createObjectURL(blob);
      await img.decode();
      return { type:'image', data:img, width:img.naturalWidth || img.width, height:img.naturalHeight || img.height };
    }

    function addVisualFromBitmapOrImage(src){
      // Maintain aspect
      const aspect = src.width / src.height;
      const h = 1.0; const w = h * aspect;
      const geo = new THREE.PlaneGeometry(w, h);

      if (texture){ texture.dispose(); }
      if (src.type === 'bitmap'){
        texture = new THREE.CanvasTexture(src.data); // ImageBitmap accepted by CanvasTexture/Texture
      } else {
        texture = new THREE.Texture(src.data);
        texture.needsUpdate = true;
      }
      texture.colorSpace = THREE.SRGBColorSpace;

      const mat = new THREE.MeshStandardMaterial({ map: texture, roughness:0.6, metalness:0.0, side:THREE.DoubleSide });
      if (plane){ plane.geometry.dispose(); plane.material.dispose(); scene.remove(plane); }
      plane = new THREE.Mesh(geo, mat);
      plane.rotation.x = -Math.PI * 0.5; // lay flat
      scene.add(plane);

      controls.target.set(0,0,0);
      camera.position.set(w*0.9, h*0.8, w*0.9);
    }

    document.getElementById('file').addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if (!file){ setStatus('파일 선택 안 됨'); return; }
      setStatus('이미지 로드 중…');
      try{
        const src = await blobToImageBitmapOrImage(file);
        addVisualFromBitmapOrImage(src);
        setStatus('완료: 장면에 텍스처 적용됨');
      }catch(err){
        console.error(err);
        setStatus('실패: 이미지를 불러올 수 없습니다. (브라우저 권한/파일형식 확인)');
      }
    });

    document.getElementById('btnGrid').onclick = ()=> grid.visible = !grid.visible;
    document.getElementById('btnReset').onclick = ()=>{ controls.reset(); camera.position.set(1.2,0.9,1.2); };
    document.getElementById('btnGLB').onclick = ()=>{
      const exporter = new THREE.GLTFExporter();
      exporter.parse(scene, (glb)=>{
        const blob = new Blob([glb instanceof ArrayBuffer ? glb : new Uint8Array(glb)], {type:'model/gltf-binary'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'scene.glb'; a.click();
      }, {binary:true, onlyVisible:true});
    };
    document.getElementById('btnOBJ').onclick = ()=>{
      const exporter = new THREE.OBJExporter();
      const text = exporter.parse(scene);
      const blob = new Blob([text], {type:'text/plain'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'scene.obj'; a.click();
    };

    // iOS/Samsung Internet quirks helper
    document.addEventListener('touchstart', ()=>{}, {passive:true});
  </script>
</body>
</html>
